function [residual, jacobian] = myFun(x) 
%function [residual, jacobian, weights, color] = reprojectionFn(x) 

    % Precondition: 
    % Expects the following variables to be in the workspace. Load these
    % variables before calling this function
    % 
    %
    % translation (3x1) - x,y,z translation
    %
    % thetas (3x1) - x,y,z rotations in radians
    
    global xPrev; % feature 3D coord. [x_k_1,y_k_1,z_k_1] z_k_1=1 if no depth
    global xCurrent; % featureCurrent normailized coord. [x_bar_k,y_bar_k,1]
    global numD; % number of depth
    
    % T = translation; t = theta
    T = x(1:3);
    t = x(4:6);
    %extracted from the symbolic expression
    depth_exp1 = @(T,t,pXk_1,pXbk) T(1) - T(3)*pXbk(1) + pXk_1(1)*(pXbk(1)*((t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) + ((t(2)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + 1) - pXk_1(3)*(pXbk(1)*(((t(1)^2 + t(2)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + 1) - (t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) - pXk_1(2)*(pXbk(1)*((t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - (t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) + (t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2));
    depth_exp2 = @(T,t,pXk_1,pXbk) T(2) - T(3)*pXbk(2) + pXk_1(2)*(((t(1)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) - pXbk(2)*((t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - (t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) + 1) - pXk_1(3)*(pXbk(2)*(((t(1)^2 + t(2)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + 1) + (t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) + pXk_1(1)*(pXbk(2)*((t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) + (t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - (t(1)*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2));
    nodepth_exp1 = @(T,t,pXbk_1, pXbk) pXbk_1(1)*((T(2) - T(3)*pXbk(2))*(((t(2)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + 1) + ((t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2))*(T(2)*pXbk(1) - T(1)*pXbk(2)) - ((t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - (t(1)*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2))*(T(1) - T(3)*pXbk(1))) - pXbk_1(2)*((T(1) - T(3)*pXbk(1))*(((t(1)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + 1) + ((t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - (t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2))*(T(2)*pXbk(1) - T(1)*pXbk(2)) + ((t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2))*(T(2) - T(3)*pXbk(2))) - (T(2)*pXbk(1) - T(1)*pXbk(2))*(((t(1)^2 + t(2)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + 1) + ((t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2))*(T(1) - T(3)*pXbk(1)) + ((t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - (t(1)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2))*(T(2) - T(3)*pXbk(2));

    depth_exp1_Jacobian = @(T,t,pXk_1,pXbk) [ 1, 0, -pXbk(1), pXk_1(3)*(pXbk(1)*((2*t(1)*(t(1)^2 + t(2)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 - (2*t(1)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) - (t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)*t(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(1)^2*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)^2*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) - pXk_1(1)*(pXbk(1)*((t(1)*t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (t(1)*t(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)^2*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)^2*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) + (2*t(1)*(t(2)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 + (t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(2)^2 + t(3)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) - (pXk_1(2)*(2*t(1)^2*t(2) - t(2)*(t(1)^2 + t(2)^2 + t(3)^2) - 2*t(1)^2*t(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) + t(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2) + pXbk(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + t(1)^2*pXbk(1)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2) - t(1)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - 2*t(1)*t(2)*t(3)*pXbk(1) - t(1)^2*t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - t(1)^2*pXbk(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + t(1)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2) + 2*t(1)*t(2)*t(3)*pXbk(1)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) + t(1)*t(2)*t(3)*pXbk(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^2, pXk_1(3)*(pXbk(1)*((2*t(2)*(t(1)^2 + t(2)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 - (2*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) + sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(2)^2*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(2)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(1)*t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) - pXk_1(1)*(pXbk(1)*((t(2)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (t(2)^2*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)*t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) - (2*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (2*t(2)*(t(2)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 + (t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(2)^2 + t(3)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) - pXk_1(2)*(pXbk(1)*((t(1)*t(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(2)^2*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(2)^2*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) + (t(1)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(2)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (t(1)*t(2)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (2*t(1)*t(2)^2*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2), pXk_1(3)*(pXbk(1)*((2*t(3)*(t(1)^2 + t(2)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 + (t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) - (t(1)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(2)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(1)*t(3)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(3)^2*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) - pXk_1(1)*(pXbk(1)*((t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (t(2)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)*t(3)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(3)^2*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) - (2*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (2*t(3)*(t(2)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 + (t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(2)^2 + t(3)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) - (pXk_1(2)*(sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - t(3)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - 2*t(2)*t(3)^2*pXbk(1) + t(2)*pXbk(1)*(t(1)^2 + t(2)^2 + t(3)^2) + t(3)^2*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2) + 2*t(1)*t(2)*t(3) - 2*t(1)*t(2)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) + 2*t(2)*t(3)^2*pXbk(1)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - t(2)*pXbk(1)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2) + t(2)*t(3)^2*pXbk(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + t(1)*t(3)*pXbk(1)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2) - t(1)*t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - t(1)*t(3)*pXbk(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^2];
    depth_exp2_Jacobian = @(T,t,pXk_1,pXbk) [ 0, 1, -pXbk(2), pXk_1(3)*(pXbk(2)*((2*t(1)*(t(1)^2 + t(2)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 - (2*t(1)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) - sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - (t(1)^2*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(1)*t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) - pXk_1(2)*(pXbk(2)*(sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)^2*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(1)*t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) - (2*t(1)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (2*t(1)*(t(1)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 + (t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(3)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) - pXk_1(1)*(pXbk(2)*((t(1)*t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (t(1)*t(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)^2*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)^2*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) + (t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (t(1)^2*t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (2*t(1)^2*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2), pXk_1(3)*(pXbk(2)*((2*t(2)*(t(1)^2 + t(2)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 - (2*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) - (t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*t(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)*t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(2)^2*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(2)^2*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) - pXk_1(2)*(pXbk(2)*((t(1)*t(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(2)^2*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(2)^2*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) + (2*t(2)*(t(1)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 + (t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(3)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) + (pXk_1(1)*(t(1)*(t(1)^2 + t(2)^2 + t(3)^2) - 2*t(1)*t(2)^2 + 2*t(1)*t(2)^2*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - t(1)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2) + pXbk(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + t(2)^2*pXbk(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2) - t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + 2*t(1)*t(2)*t(3)*pXbk(2) + t(1)*t(2)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - t(2)^2*pXbk(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + t(2)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2) - 2*t(1)*t(2)*t(3)*pXbk(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - t(1)*t(2)*t(3)*pXbk(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^2, pXk_1(3)*(pXbk(2)*((2*t(3)*(t(1)^2 + t(2)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 + (t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) - (t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(2)*t(3)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(2)*t(3)^2*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) - pXk_1(2)*(pXbk(2)*((t(1)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(2)*t(3)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(2)*t(3)^2*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) - (2*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (2*t(3)*(t(1)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 + (t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(3)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) + (pXk_1(1)*(sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - t(3)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + 2*t(1)*t(3)^2*pXbk(2) - t(1)*pXbk(2)*(t(1)^2 + t(2)^2 + t(3)^2) + t(3)^2*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2) - 2*t(1)*t(2)*t(3) + 2*t(1)*t(2)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 2*t(1)*t(3)^2*pXbk(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) + t(1)*pXbk(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2) - t(1)*t(3)^2*pXbk(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + t(2)*t(3)*pXbk(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2) + t(1)*t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - t(2)*t(3)*pXbk(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^2];
    nodepth_exp1_Jacobian = @(T,t,pXbk_1, pXbk) [ pXbk(2)*(((t(1)^2 + t(2)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + 1) - pXbk_1(2)*(((t(1)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) - pXbk(2)*((t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - (t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) + 1) - pXbk_1(1)*(pXbk(2)*((t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) + (t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - (t(1)*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) + (t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2), pXbk_1(1)*(pXbk(1)*((t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) + ((t(2)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + 1) - pXbk(1)*(((t(1)^2 + t(2)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + 1) - pXbk_1(2)*(pXbk(1)*((t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - (t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) + (t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) + (t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - (t(1)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2), pXbk_1(1)*(pXbk(1)*((t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - (t(1)*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) - pXbk(2)*(((t(2)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + 1)) - pXbk(2)*((t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) - (t(1)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) - pXbk(1)*((t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) + pXbk_1(2)*(pXbk(2)*((t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)) + pXbk(1)*(((t(1)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + 1)), (T(2)*pXbk(1) - T(1)*pXbk(2))*((2*t(1)*(t(1)^2 + t(2)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 - (2*t(1)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) - pXbk_1(1)*((T(2)*pXbk(1) - T(1)*pXbk(2))*((t(1)*t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (t(1)*t(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)^2*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)^2*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) + (T(1) - T(3)*pXbk(1))*((t(1)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(1)^2*t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)^2*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) + ((2*t(1)*(t(2)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 + (t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(2)^2 + t(3)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2))*(T(2) - T(3)*pXbk(2))) + (T(2) - T(3)*pXbk(2))*((t(1)*t(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(1)^2*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)^2*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) + pXbk_1(2)*((T(2) - T(3)*pXbk(2))*((t(1)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (t(1)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)^2*t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)^2*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) + (T(1) - T(3)*pXbk(1))*((2*t(1)*(t(1)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 - (2*t(1)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(3)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) - (T(2)*pXbk(1) - T(1)*pXbk(2))*(sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)^2*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(1)*t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2)) - (T(1) - T(3)*pXbk(1))*((t(1)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (t(1)^2*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)*t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2), (T(2)*pXbk(1) - T(1)*pXbk(2))*((2*t(2)*(t(1)^2 + t(2)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 - (2*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) + pXbk_1(2)*((T(2) - T(3)*pXbk(2))*((t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (t(2)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)*t(2)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(2)^2*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) - (T(2)*pXbk(1) - T(1)*pXbk(2))*((t(1)*t(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(2)^2*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(2)^2*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) + ((2*t(2)*(t(1)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 + (t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(3)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2))*(T(1) - T(3)*pXbk(1))) - (T(1) - T(3)*pXbk(1))*((t(1)*t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (t(1)*t(2)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(2)^2*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(2)^2*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) - pXbk_1(1)*((T(1) - T(3)*pXbk(1))*((t(2)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(1)*t(2)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(2)^2*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) + (T(2)*pXbk(1) - T(1)*pXbk(2))*((t(2)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (t(2)^2*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)*t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) + (T(2) - T(3)*pXbk(2))*((2*t(2)*(t(2)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 - (2*t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(2)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(2)^2 + t(3)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2))) + (T(2) - T(3)*pXbk(2))*(sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(2)^2*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(2)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(1)*t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2), ((2*t(3)*(t(1)^2 + t(2)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 + (t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(2)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2))*(T(2)*pXbk(1) - T(1)*pXbk(2)) - (T(1) - T(3)*pXbk(1))*((t(1)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (t(1)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(2)*t(3)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(2)*t(3)^2*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) + (T(2) - T(3)*pXbk(2))*((t(2)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(1)*t(3)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(3)^2*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) - pXbk_1(1)*((T(2)*pXbk(1) - T(1)*pXbk(2))*((t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (t(2)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(1)*t(3)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(3)^2*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) + (T(2) - T(3)*pXbk(2))*((2*t(3)*(t(2)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 - (2*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(2)^2 + t(3)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) + (T(1) - T(3)*pXbk(1))*(sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(3)^2*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(3)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(1)*t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2)) + pXbk_1(2)*((T(1) - T(3)*pXbk(1))*((2*t(3)*(t(1)^2 + t(3)^2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2 - (2*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) + (t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))*(t(1)^2 + t(3)^2))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2)) - (T(2)*pXbk(1) - T(1)*pXbk(2))*((t(1)*t(3)*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(2)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2) - (t(1)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (t(2)*t(3)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(2)*t(3)^2*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2) + (T(2) - T(3)*pXbk(2))*((t(3)^2*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) - (t(3)^2*cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2) - sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2))/(t(1)^2 + t(2)^2 + t(3)^2)^(1/2) + (t(1)*t(2)*t(3)*sin((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)))/(t(1)^2 + t(2)^2 + t(3)^2)^(3/2) + (2*t(1)*t(2)*t(3)*(cos((t(1)^2 + t(2)^2 + t(3)^2)^(1/2)) - 1))/(t(1)^2 + t(2)^2 + t(3)^2)^2))];
    
    residual = zeros(2*m+n,1); %residual
    jacobian = zeros(2*m+n,6); %jacobian
    weights = zeros(2*m+n,1);
    
    for i = 1:numD
        % with depth
        pXk_1 = xPrev(i,:);
        pXbk_1 = 
        
        xbki = xCurrent(i,1); % [k 1]
        ybki = xCurrent(i,2); % [k 1]
    end
    
    for i = numD+1:size(xPrev,1)
        % without depth
        
    end
end
